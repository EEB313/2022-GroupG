---
title: "EEB313 - Final Project"
Authors: "Queenny Chiu, Anna Ly, Derek Lau"
output: html_notebook
---

```{r}
library(dplyr)
library(tidyverse)
library(lubridate)
library(lmerTest)
library(lme4)
```

```{r}
mingan_flower_data <- read_csv("mingan_flower_data.csv")
head(mingan_flower_data)

mingan_weather_data <- read_csv("mingan_weather_data.csv")
head(mingan_weather_data)
```

```{r}
#changing the column name "survey_year" into "year"
colnames(mingan_flower_data)[5] <- "year"
```

```{r}
#make columns with year, month, day
dmy_weather<-mingan_weather_data %>%
mutate(date=dmy(date),
  year=lubridate::year(date),
  month=lubridate::month(date),
  day=lubridate::day(date))
dmy_weather
```

```{r}
#make column with average humidity for each month (between April and July) for each year
avg_weather <- dmy_weather%>%
  filter(month >= 4 & month <= 7 & !is.na(avg_relative_humidity) & 
           !is.na(avg_temperature)) %>% 
  group_by(month, year) %>%
  summarise(mean_avg_relative_humidity=mean(avg_relative_humidity),
            mean_avg_temp=mean(avg_temperature))
avg_weather
```

```{r}
#plot average temperature vs. average relative humidity (between April and July)
avg_weather %>%
  ggplot(aes(x=mean_avg_temp,y=mean_avg_relative_humidity))+
  geom_point() + geom_smooth(method = lm) + theme_classic()+
  labs(title = "Average Temperature vs. Average Relative Humidity 
       (between April and July)", 
       x = "Average Temperature", y = "Average Relative Humidity (%)")
```

```{r}
# Running a correlation test between average temperature and average relative humidity
cor.test(avg_weather$mean_avg_relative_humidity, avg_weather$mean_avg_temp)
```

```{r}
# find average temperature per year
mean_annual_temp <- avg_weather %>% 
  group_by(year) %>% 
  summarise(mean_annual_temp = mean(mean_avg_temp))

mean_annual_temp
```

```{r}
mean_annual_temp <- avg_weather %>% 
  group_by(year) %>% 
  summarise(mean_annual_temp = mean(mean_avg_temp))
mean_annual_temp
```

```{r}
#merge the two data into one
total <- merge(mingan_flower_data, mean_annual_temp, by="year")
total
```

```{r}
#filter out NAs
flower_temp_data <- total %>% 
  filter(!is.na(day))

flower_temp_data
```

```{r}
#first flowering date vs. temperature based on actual data
flower_temp_data %>% 
  ggplot(aes(x = mean_annual_temp, y = day)) +
  geom_smooth(method = "lm")+
  theme_classic() +
  labs(title = "First Flowering Date vs. Temperature", x = "Mean Annual Temperature (Degrees Celsius)", y = "First Flowering Date (Actual Data)" )
```

```{r}
#Model 1 (y = flowering day, x = temperature)
flower_temp_lm1 <- lm(day~mean_annual_temp, data=flower_temp_data)
summary(flower_temp_lm1)
```
#p-value = 0.01275 --> Since p-value < 0.05, temperature has a significant effect on first flowering date.

```{r}
#Model 1: validate assumptions
plot(flower_temp_lm1, 1:2)
```
# Residuals vs. Fitted plot --> homogeneity of variances at each X is met
# Normal Q-Q --> data is normally distributed


```{r}
#Model 2 (y = flowering day, x = species)
flower_temp_lm1 <- lm(day~mean_annual_temp, data=flower_temp_data)
summary(flower_temp_lm1)

```












```{r}
# create mixed effect model (temperature vs flowering date + species (random effect))

flower_temp_lm2 <- lmer(day ~ mean_annual_temp + (1|species_name), data = flower_temp_data, REML = FALSE)       
summary(flower_temp_lm2)
```


# (variance of species / total variance)*100 = (334.05/(334.05+35.48))*100 = 90.39861%
#The different species account for 90.39861% of residual variance in the model.


```{r}
# create graph of temperature (x) vs. flowering day (y) by species using actual data

flower_temp_data %>% 
  group_by(mean_annual_temp, species_name) %>% 
  ggplot(aes(x = mean_annual_temp, y = day, colour = species_name)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic() +
  labs(title = "First Flowering Date vs. Temperature (by Species)", x = "Mean Annual Temperature (Degrees Celsius)", y = "First Flowering Date (Actual Data)" )
```


```{r}
#create graph of temperature (x) vs. flowering day (y) by species using predicted data
flower_temp_data <- flower_temp_data %>% 
  mutate(flowering_date_pred_spec = predict(flower_temp_lm2)) #add predicted values to dataset

flower_temp_data %>% 
  ggplot(aes(x = mean_annual_temp, y = day, colour = species_name)) +
  theme_classic() +
  labs(title = "First Flowering Date vs. Temperature", x = "Mean Annual Temperature (Degrees Celsius)", y = "First Flowering Date (Predicted Data)" ) +
  
#Add fixed effect regression line (from model output above)
  geom_abline(aes(intercept=174.7261, slope=-2.6379), size=2) +


#Add fitted values (i.e., regression lines)
  geom_line(aes(y = flowering_date_pred_spec), size = 1) +
  geom_point(size = 1.2)
```
#The thick black line corresponds to the fitted values associated with the fixed-effect component of the model. The thin coloured lines correspond to the fitted values estimated for each species.


```{r}
# create mixed effect model (temperature vs flowering date + station (random effect))

flower_temp_lm3 <- lmer(day ~ mean_annual_temp + (1|island/station_name), data = flower_temp_data, REML = FALSE)       
summary(flower_temp_lm3)

#ASK TA
#basic (flower date vs. temperature)

#random effects:
#+species
#+island/station (or only station)
#+species + island/station (or only station)
```


```{r}
# create graph of temperature (x) vs. flowering day (y) by island (??) using actual data

flower_temp_data %>% 
  group_by(mean_annual_temp, island, species_name) %>% 
  ggplot(aes(x = mean_annual_temp, y = day, colour = island)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic() +
  facet_wrap(~species_name)
  labs(title = "First Flowering Date vs. Temperature (by Island)", x = "Mean Annual Temperature (Degrees Celsius)", y = "First Flowering Date (Actual Data)" )
```


```{r}
# create mixed effect model (temperature vs flowering date + species + station (random effects))

flower_temp_lm4 <- lmer(day ~ mean_annual_temp + (1|species_name) + (1|island/station_name), data = flower_temp_data, REML = FALSE)       
summary(flower_temp_lm4)
```

